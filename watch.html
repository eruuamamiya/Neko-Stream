<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonton Anime - NekoStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: sans-serif; }
        .nav-link { color: #e5e7eb; font-size: 0.875rem; font-weight: 600; transition: color 0.2s; }
        .nav-link:hover { color: #60a5fa; }
        
        /* Responsive Iframe Container */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background: #000;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col pb-20">

    <header class="bg-[#161b22] border-b border-[#30363d] sticky top-0 z-50 p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <nav class="flex flex-wrap justify-center gap-6">
                <a href="index.html" class="nav-link">Home</a>
                <a href="ongoing.html" class="nav-link">On Going</a>
                <a href="jadwal.html" class="nav-link">Jadwal Rilis</a>
                <a href="list-anime.html" class="nav-link">List Anime</a>
                <a href="genre.html" class="nav-link">List Genre</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 max-w-5xl">
        
        <div id="loading" class="text-center py-20">
            <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
            <p class="text-gray-500 text-xs">Memuat video...</p>
        </div>

        <div id="debug-area" class="hidden bg-black border border-red-500 p-4 rounded mb-6 text-xs text-gray-300 overflow-x-auto"></div>

        <div id="watch-content" class="hidden">
            
            <h1 id="ep-title" class="text-lg md:text-xl font-bold text-white mb-4 leading-tight">...</h1>

            <div class="video-container mb-4 border border-[#30363d]">
                <iframe id="video-frame" src="" allowfullscreen></iframe>
            </div>

            <div class="flex flex-col md:flex-row gap-4 justify-between items-center mb-6 bg-[#161b22] p-4 rounded-lg border border-[#30363d]">
                
                <div class="w-full md:w-auto">
                    <label class="block text-xs text-gray-500 mb-1">Ganti Episode:</label>
                    <select id="episode-select" class="w-full md:w-64 bg-[#0d1117] text-white text-sm border border-[#30363d] rounded p-2 focus:border-blue-500 focus:outline-none">
                        <option>Memuat list...</option>
                    </select>
                </div>

                <div class="flex gap-2 w-full md:w-auto justify-end">
                    <a id="btn-prev" href="#" class="px-4 py-2 bg-gray-700 rounded text-sm font-bold text-gray-400 cursor-not-allowed transition" style="pointer-events: none;">
                        ‚Üê Prev
                    </a>
                    <a id="btn-next" href="#" class="px-4 py-2 bg-gray-700 rounded text-sm font-bold text-gray-400 cursor-not-allowed transition" style="pointer-events: none;">
                        Next ‚Üí
                    </a>
                </div>
            </div>

            <div class="mb-8 bg-[#161b22] p-5 rounded-lg border border-[#30363d]">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <span class="text-green-500">üì•</span> Download
                </h3>
                <div id="download-container" class="space-y-4">
                    <p class="text-gray-500 text-sm">Tidak ada link download.</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Gunakan Config Global
        if (typeof API_BASE_URL === 'undefined') { var API_BASE_URL = "https://reduced-confidence-muscle-baseline.trycloudflare.com"; }

        const urlParams = new URLSearchParams(window.location.search);
        const episodeId = urlParams.get('id');

        document.addEventListener("DOMContentLoaded", () => {
            if (!episodeId) {
                showError("ID Episode tidak ditemukan. Silakan pilih dari halaman detail.");
                return;
            }
            fetchEpisodeData();
        });

        // Event listener ganti episode via dropdown
        document.getElementById('episode-select').addEventListener('change', (e) => {
            const newId = e.target.value;
            if (newId && newId !== "#") {
                window.location.href = `watch.html?id=${newId}`;
            }
        });

        async function fetchEpisodeData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('watch-content');
            
            try {
                // Endpoint: /otakudesu/episode/{episodeId}
                const endpoint = `${API_BASE_URL}/otakudesu/episode/${episodeId}`;
                
                const req = await fetch(endpoint);
                if (!req.ok) throw new Error("Gagal mengambil data episode");
                
                const res = await req.json();
                
                // DATA ADA DI DALAM 'details' (Sesuai JSON Kamu)
                const data = res.data?.details;

                if (!data) throw new Error("Data episode kosong.");

                // 1. Set Judul
                document.title = data.title;
                document.getElementById('ep-title').innerText = data.title;

                // 2. Set Video Player (Default Streaming URL)
                const iframe = document.getElementById('video-frame');
                if (data.defaultStreamingUrl) {
                    iframe.src = data.defaultStreamingUrl;
                } else {
                    iframe.src = ""; // Kosongkan jika tidak ada link
                    alert("Link streaming tidak ditemukan.");
                }

                // 3. Navigasi Next/Prev
                setupNavigation(data);

                // 4. Download Links
                // Cek data.download.qualityList (Sesuai JSON)
                if (data.download && data.download.qualityList) {
                    renderDownloadList(data.download.qualityList);
                }

                // 5. Episode List Dropdown
                // Cek data.info.episodeList
                if (data.info && data.info.episodeList) {
                    setupEpisodeDropdown(data.info.episodeList);
                }

                loading.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showError(err.message);
            }
        }

        function setupNavigation(data) {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');

            // Cek hasPrevEpisode (boolean)
            if (data.hasPrevEpisode && data.prevEpisode) {
                btnPrev.href = `watch.html?id=${data.prevEpisode.episodeId}`;
                btnPrev.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                btnPrev.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btnPrev.style.pointerEvents = 'auto';
            }

            // Cek hasNextEpisode (boolean)
            if (data.hasNextEpisode && data.nextEpisode) {
                btnNext.href = `watch.html?id=${data.nextEpisode.episodeId}`;
                btnNext.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
                btnNext.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btnNext.style.pointerEvents = 'auto';
            }
        }

        function renderDownloadList(qualityList) {
            const container = document.getElementById('download-container');
            
            if (qualityList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Tidak ada link download.</p>';
                return;
            }

            let html = '';
            qualityList.forEach(quality => {
                // quality.title = "360p", quality.size = "38.8 MB"
                const resTitle = quality.title || 'Unknown';
                const size = quality.size || '';
                const urls = quality.urlList || [];

                html += `
                <div class="border-b border-[#30363d] pb-3 last:border-0 last:pb-0">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-gray-700 text-white text-xs font-bold px-2 py-1 rounded">${resTitle}</span>
                        <span class="text-xs text-gray-500">${size}</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${urls.map(link => `
                            <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                               class="text-xs bg-blue-900/30 text-blue-400 border border-blue-500/30 hover:bg-blue-600 hover:text-white px-3 py-1 rounded transition">
                               ${link.title}
                            </a>
                        `).join('')}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        function setupEpisodeDropdown(list) {
            const select = document.getElementById('episode-select');
            select.innerHTML = ''; // Clear loading

            // JSON Otakudesu biasanya mengembalikan list dari episode terbaru ke terlama
            // Kita masukkan semua ke dropdown
            list.forEach(ep => {
                const option = document.createElement('option');
                option.value = ep.episodeId;
                option.text = ep.title; // Misal: "Episode 12"
                
                // Tandai episode yang sedang aktif
                if (ep.episodeId === episodeId) {
                    option.selected = true;
                }
                
                select.appendChild(option);
            });
        }

        function showError(msg) {
            const debug = document.getElementById('debug-area');
            document.getElementById('loading').classList.add('hidden');
            debug.classList.remove('hidden');
            debug.innerText = "Error: " + msg;
        }
    </script>
</body>
</html>
