<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nonton Anime - NekoStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: sans-serif; }
        .nav-link { color: #e5e7eb; font-size: 0.875rem; font-weight: 600; transition: color 0.2s; }
        .nav-link:hover { color: #60a5fa; }
        
        .video-container {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background: #000;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        /* Style untuk tombol server aktif */
        .server-btn.active {
            background-color: #2563eb; /* Blue 600 */
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col pb-20">

    <header class="bg-[#161b22] border-b border-[#30363d] sticky top-0 z-50 p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <nav class="flex flex-wrap justify-center gap-6">
                <a href="index.html" class="nav-link">Home</a>
                <a href="ongoing.html" class="nav-link">On Going</a>
                <a href="jadwal.html" class="nav-link">Jadwal Rilis</a>
                <a href="list-anime.html" class="nav-link">List Anime</a>
                <a href="genre.html" class="nav-link">List Genre</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6 max-w-5xl">
        
        <div id="loading" class="text-center py-20">
            <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div>
            <p class="text-gray-500 text-xs">Memuat video...</p>
        </div>

        <div id="watch-content" class="hidden">
            
            <h1 id="ep-title" class="text-lg md:text-xl font-bold text-white mb-4 leading-tight">...</h1>

            <div class="video-container mb-6 border border-[#30363d]">
                <iframe id="video-frame" src="" allowfullscreen></iframe>
            </div>

            <div id="server-container" class="mb-6 bg-[#161b22] p-4 rounded-lg border border-[#30363d] hidden">
                <h3 class="text-sm font-bold text-gray-300 mb-3 flex items-center gap-2">
                    <span>üì°</span> Ganti Server / Resolusi
                </h3>
                <div id="server-list" class="space-y-3">
                    </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 justify-between items-center mb-6 bg-[#161b22] p-4 rounded-lg border border-[#30363d]">
                <div class="w-full md:w-auto">
                    <label class="block text-xs text-gray-500 mb-1">Pilih Episode Lain:</label>
                    <select id="episode-select" class="w-full md:w-64 bg-[#0d1117] text-white text-sm border border-[#30363d] rounded p-2 focus:border-blue-500 focus:outline-none cursor-pointer">
                        <option value="#">Memuat list...</option>
                    </select>
                </div>

                <div class="flex gap-2 w-full md:w-auto justify-end">
                    <a id="btn-prev" href="#" class="px-4 py-2 bg-gray-700 rounded text-sm font-bold text-gray-400 cursor-not-allowed transition pointer-events-none flex items-center gap-1">
                        <span>‚Üê</span> Prev
                    </a>
                    <a id="btn-next" href="#" class="px-4 py-2 bg-gray-700 rounded text-sm font-bold text-gray-400 cursor-not-allowed transition pointer-events-none flex items-center gap-1">
                        Next <span>‚Üí</span>
                    </a>
                </div>
            </div>

            <div class="mb-8 bg-[#161b22] p-5 rounded-lg border border-[#30363d]">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2 border-b border-[#30363d] pb-2">
                    <span class="text-green-500">üì•</span> Link Download
                </h3>
                <div id="download-container" class="space-y-4">
                    <p class="text-gray-500 text-sm">Tidak ada link download.</p>
                </div>
            </div>

        </div>
    </main>

    <script>
        if (typeof API_BASE_URL === 'undefined') { var API_BASE_URL = "https://style-demonstrated-nutten-mark.trycloudflare.com/otakudesu"; }

        const urlParams = new URLSearchParams(window.location.search);
        const episodeId = urlParams.get('id');

        document.addEventListener("DOMContentLoaded", () => {
            if (!episodeId) {
                alert("ID Episode tidak ditemukan.");
                return;
            }
            fetchEpisodeData();
        });

        // Dropdown Ganti Episode
        document.getElementById('episode-select').addEventListener('change', (e) => {
            const newId = e.target.value;
            if (newId && newId !== "#") window.location.href = `watch.html?id=${newId}`;
        });

        async function fetchEpisodeData() {
            const loading = document.getElementById('loading');
            const content = document.getElementById('watch-content');
            
            try {
                const endpoint = `${API_BASE_URL}/otakudesu/episode/${episodeId}`;
                const req = await fetch(endpoint);
                const res = await req.json();
                const data = res.data?.details;

                if (!data) throw new Error("Data episode kosong.");

                // 1. Info Utama
                document.title = data.title;
                document.getElementById('ep-title').innerText = data.title;

                // 2. Default Player
                const iframe = document.getElementById('video-frame');
                if (data.defaultStreamingUrl) {
                    iframe.src = data.defaultStreamingUrl;
                }

                // 3. Render Server List (FITUR BARU)
                if (data.server && data.server.qualityList) {
                    renderServerList(data.server.qualityList);
                }

                // 4. Navigasi & Download
                setupNavigation(data);
                if (data.download && data.download.qualityList) {
                    renderDownloadList(data.download.qualityList);
                }
                if (data.info && data.info.episodeList) {
                    setupEpisodeDropdown(data.info.episodeList);
                }

                loading.classList.add('hidden');
                content.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                loading.innerHTML = `<p class="text-red-500">Error: ${err.message}</p>`;
            }
        }

        // --- FUNGSI RENDER LIST SERVER ---
        function renderServerList(qualityList) {
            const container = document.getElementById('server-list');
            const wrapper = document.getElementById('server-container');
            
            if (!qualityList || qualityList.length === 0) return;

            wrapper.classList.remove('hidden');
            let html = '';

            qualityList.forEach(quality => {
                // quality.title = "Mirror 360p"
                const resName = quality.title.replace('Mirror', '').trim(); 
                const servers = quality.serverList || [];

                html += `
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 border-b border-[#30363d] pb-2 last:border-0">
                    <div class="w-20 shrink-0">
                        <span class="text-xs font-bold text-blue-400 bg-blue-900/20 px-2 py-1 rounded border border-blue-500/30">${resName}</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${servers.map(srv => `
                            <button onclick="changeServer('${srv.serverId}', this)" 
                                    class="server-btn text-xs bg-[#21262d] text-gray-300 border border-[#30363d] hover:bg-gray-700 px-3 py-1.5 rounded transition">
                                ${srv.title}
                            </button>
                        `).join('')}
                    </div>
                </div>`;
            });

            container.innerHTML = html;
        }

        // --- FUNGSI GANTI SERVER (Fetch URL Asli) ---
        async function changeServer(serverId, btnElement) {
            // Ubah tampilan tombol jadi loading/aktif
            const allBtns = document.querySelectorAll('.server-btn');
            allBtns.forEach(b => b.classList.remove('active', 'bg-blue-600', 'text-white'));
            
            btnElement.innerText = "Loading...";
            btnElement.disabled = true;

            try {
                // Panggil API untuk decode serverId
                // Endpoint umum: /otakudesu/server/{serverId}
                const req = await fetch(`${API_BASE_URL}/otakudesu/server/${serverId}`);
                const res = await req.json();
                
                // Biasanya URL ada di res.data.url atau res.url
                const videoUrl = res.data?.url || res.url;

                if (videoUrl) {
                    document.getElementById('video-frame').src = videoUrl;
                    
                    // Update style tombol jadi sukses
                    btnElement.innerText = "Playing";
                    btnElement.classList.add('active');
                    btnElement.disabled = false;
                } else {
                    alert("Gagal mendapatkan link video dari server ini.");
                    btnElement.innerText = "Error";
                }

            } catch (err) {
                console.error(err);
                alert("Gagal menghubungi server mirror.");
                btnElement.innerText = "Failed";
                btnElement.disabled = false;
            }
        }

        function setupNavigation(data) {
            const btnPrev = document.getElementById('btn-prev');
            const btnNext = document.getElementById('btn-next');

            if (data.hasPrevEpisode && data.prevEpisode) {
                btnPrev.href = `watch.html?id=${data.prevEpisode.episodeId}`;
                btnPrev.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed', 'pointer-events-none');
                btnPrev.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }

            if (data.hasNextEpisode && data.nextEpisode) {
                btnNext.href = `watch.html?id=${data.nextEpisode.episodeId}`;
                btnNext.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed', 'pointer-events-none');
                btnNext.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
            }
        }

        function renderDownloadList(qualityList) {
            const container = document.getElementById('download-container');
            if (qualityList.length === 0) return;

            let html = '';
            qualityList.forEach(quality => {
                const resTitle = quality.title || 'Unknown';
                const size = quality.size || '';
                const urls = quality.urlList || [];

                html += `
                <div class="border-b border-[#30363d] pb-3 last:border-0 last:pb-0">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-gray-700 text-white text-xs font-bold px-2 py-1 rounded">${resTitle}</span>
                        <span class="text-xs text-gray-500 font-mono">${size}</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        ${urls.map(link => `
                            <a href="${link.url}" target="_blank" class="text-xs bg-[#21262d] text-blue-400 border border-blue-900/30 hover:bg-blue-600 hover:text-white px-3 py-1.5 rounded transition">
                               ${link.title}
                            </a>
                        `).join('')}
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function setupEpisodeDropdown(list) {
            const select = document.getElementById('episode-select');
            select.innerHTML = ''; 
            list.forEach(ep => {
                const option = document.createElement('option');
                option.value = ep.episodeId;
                option.text = ep.title;
                if (ep.episodeId === episodeId) option.selected = true;
                select.appendChild(option);
            });
        }
    </script>
</body>
</html>
