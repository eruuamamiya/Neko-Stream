<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Anime - NekoStream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="config.js"></script>
    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: sans-serif; }
        .nav-link { color: #e5e7eb; font-size: 0.875rem; font-weight: 600; transition: color 0.2s; }
        .nav-link:hover { color: #60a5fa; }
        .glass-panel {
            background: rgba(22, 27, 34, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(48, 54, 61, 0.5);
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col pb-20">

<header class="bg-[#161b22] border-b border-[#30363d] sticky top-0 z-50 p-4 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            
            <a href="index.html" class="text-2xl font-bold text-white tracking-wider flex items-center gap-2 hover:text-blue-400 transition-colors">
                <span class="text-blue-500 text-3xl"></span> NekoStream
            </a>

            <nav class="flex flex-wrap justify-center gap-6">
                <a href="index.html" class="nav-link" id="nav-home">Home</a>
                <a href="ongoing.html" class="nav-link" id="nav-ongoing">On Going</a>
                <a href="jadwal.html" class="nav-link" id="nav-jadwal">Jadwal Rilis</a>
                <a href="list-anime.html" class="nav-link" id="nav-list">List Anime</a>
                <a href="genre.html" class="nav-link" id="nav-genre">List Genre</a>
            </nav>

        </div>
    </header>

    <div id="loading" class="flex flex-col items-center justify-center min-h-[80vh]">
        <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-500 text-sm">Sedang mengambil detail anime...</p>
    </div>

    <div id="error-msg" class="hidden flex flex-col items-center justify-center min-h-[80vh] text-center px-4">
        <p class="text-red-400 font-bold text-lg mb-2">Gagal Memuat Data</p>
        <p class="text-gray-500 text-sm mb-4" id="error-text">Terjadi kesalahan koneksi.</p>
        <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-white text-sm transition">Coba Lagi</button>
    </div>

    <main id="main-content" class="container mx-auto p-4 md:p-6 hidden">
        
        <div class="flex flex-col md:flex-row gap-8 mb-10">
            <div class="w-full md:w-auto flex-shrink-0 flex justify-center md:justify-start">
                <div class="sticky top-24 w-48 md:w-56"> 
                    <img id="anime-poster" src="" alt="Poster" class="w-full rounded-lg shadow-2xl border border-[#30363d] object-cover aspect-[3/4]">
                    
                    <div id="batch-container" class="mt-4 hidden">
                        <a id="batch-link" href="#" class="block w-full bg-green-700 hover:bg-green-600 text-white text-center py-2 px-4 rounded-lg font-bold text-sm shadow-lg transition flex items-center justify-center gap-2">
                            <span>ðŸ“¦</span> Batch
                        </a>
                    </div>
                </div>
            </div>

            <div class="flex-grow">
                <h1 id="anime-title" class="text-2xl md:text-3xl font-bold text-white mb-2 leading-tight text-center md:text-left"></h1>
                <p id="anime-japanese" class="text-gray-400 text-sm mb-4 italic text-center md:text-left"></p>

                <div class="flex flex-wrap gap-3 mb-6 justify-center md:justify-start">
                    <span class="bg-blue-900/30 text-blue-400 border border-blue-500/30 px-3 py-1 rounded text-xs font-bold uppercase" id="anime-type">TV</span>
                    <span class="bg-purple-900/30 text-purple-400 border border-purple-500/30 px-3 py-1 rounded text-xs font-bold uppercase" id="anime-status">Ongoing</span>
                    <span class="bg-yellow-900/30 text-yellow-400 border border-yellow-500/30 px-3 py-1 rounded text-xs font-bold" id="anime-score">â˜… 0.0</span>
                </div>

                <div class="glass-panel rounded-lg p-4 mb-6 text-sm text-gray-300 grid grid-cols-1 md:grid-cols-2 gap-y-2 gap-x-4">
                    <p><span class="text-gray-500">Studios:</span> <span id="anime-studio" class="text-white"></span></p>
                    <p><span class="text-gray-500">Rilis:</span> <span id="anime-aired" class="text-white"></span></p>
                    <p><span class="text-gray-500">Total Eps:</span> <span id="anime-eps" class="text-white"></span></p>
                    <p><span class="text-gray-500">Durasi:</span> <span id="anime-duration" class="text-white"></span></p>
                    <p class="col-span-1 md:col-span-2"><span class="text-gray-500">Produser:</span> <span id="anime-producers" class="text-white"></span></p>
                    <p class="col-span-1 md:col-span-2 flex items-start gap-1">
                        <span class="text-gray-500 whitespace-nowrap">Genre:</span> 
                        <span id="anime-genres" class="flex flex-wrap gap-2"></span>
                    </p>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-bold text-white mb-3 border-l-4 border-blue-500 pl-3">Sinopsis</h3>
                    <div id="anime-synopsis" class="text-gray-300 leading-relaxed text-sm space-y-3"></div>
                </div>
            </div>
        </div>

        <div class="mb-12">
            <div class="flex items-center justify-between mb-4 border-b border-[#30363d] pb-2">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">ðŸ“º List Episode</h3>
                <span class="text-xs text-gray-500 bg-[#161b22] px-2 py-1 rounded border border-[#30363d]">Terbaru di Atas</span>
            </div>
            <div id="episode-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-[400px] overflow-y-auto pr-2 custom-scroll"></div>
        </div>

        <div>
            <h3 class="text-xl font-bold text-white mb-4 border-b border-[#30363d] pb-2">ðŸ”¥ Anime Sejenis</h3>
            <div id="recommendation-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
        </div>

    </main>

    <script>
        if (typeof API_BASE_URL === 'undefined') { var API_BASE_URL = "https://style-demonstrated-nutten-mark.trycloudflare.com/otakudesu/anime/"; }

        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const animeId = urlParams.get('id');

            if (!animeId) {
                showError("ID Anime tidak ditemukan.");
                return;
            }

            fetchAnimeDetails(animeId);
        });

        async function fetchAnimeDetails(id) {
            const loading = document.getElementById('loading');
            const mainContent = document.getElementById('main-content');
            
            try {
                const req = await fetch(`${API_BASE_URL}/otakudesu/anime/${id}`);
                
                if (!req.ok) throw new Error("Gagal mengambil data anime.");
                
                const res = await req.json();
                const data = res.data?.details;

                if (!data) throw new Error("Data anime kosong.");

                // Render Info
                document.title = `${data.title} - NekoStream`;
                document.getElementById('anime-title').innerText = data.title;
                document.getElementById('anime-japanese').innerText = data.japanese || '';
                document.getElementById('anime-poster').src = data.poster || 'https://via.placeholder.com/300x400';
                
                document.getElementById('anime-score').innerText = `â˜… ${data.score}`;
                document.getElementById('anime-type').innerText = data.type;
                document.getElementById('anime-status').innerText = data.status;
                
                if(data.status && data.status.toLowerCase() === 'completed') {
                    const statusBadge = document.getElementById('anime-status');
                    statusBadge.classList.remove('bg-purple-900/30', 'text-purple-400', 'border-purple-500/30');
                    statusBadge.classList.add('bg-green-900/30', 'text-green-400', 'border-green-500/30');
                }

                document.getElementById('anime-studio').innerText = data.studios;
                document.getElementById('anime-aired').innerText = data.aired;
                document.getElementById('anime-eps').innerText = data.episodes;
                document.getElementById('anime-duration').innerText = data.duration;
                document.getElementById('anime-producers').innerText = data.producers;

                if (data.genreList && data.genreList.length > 0) {
                    const genreHtml = data.genreList.map(g => `
                        <a href="genre-result.html?id=${g.genreId}" 
                           class="text-blue-400 hover:text-white hover:bg-blue-600/20 px-1 rounded transition-colors underline decoration-blue-500/30">
                           ${g.title}
                        </a>
                    `).join(', ');
                    document.getElementById('anime-genres').innerHTML = genreHtml;
                } else {
                    document.getElementById('anime-genres').innerText = "-";
                }

                const synopsisContainer = document.getElementById('anime-synopsis');
                if (data.synopsis && data.synopsis.paragraphList) {
                    synopsisContainer.innerHTML = data.synopsis.paragraphList.map(p => `<p>${p}</p>`).join('');
                } else {
                    synopsisContainer.innerText = "Sinopsis tidak tersedia.";
                }

                // --- LOGIKA BATCH (Sesuai JSON Kamu) ---
                if (data.batch) {
                    const batchContainer = document.getElementById('batch-container');
                    const batchLink = document.getElementById('batch-link');
                    
                    // 1. Cek Property ID langsung
                    let batchId = data.batch.batchId || data.batch.id;

                    // 2. Jika tidak ada, coba ambil dari URL
                    if (!batchId && (data.batch.otakudesuUrl || data.batch.url)) {
                        const url = data.batch.otakudesuUrl || data.batch.url;
                        const parts = url.split('/').filter(p => p.trim() !== "");
                        if (parts.length > 0) {
                            batchId = parts[parts.length - 1]; 
                        }
                    }

                    if (batchId) {
                        batchContainer.classList.remove('hidden');
                        batchLink.href = `batch.html?id=${batchId}`;
                    } else {
                        // Jika ID batch tidak ditemukan, sembunyikan atau disable
                        batchContainer.classList.add('hidden');
                        console.warn("Ada info batch, tapi ID tidak ditemukan.", data.batch);
                    }
                }

                renderEpisodeList(data.episodeList);
                renderRecommendations(data.recommendedAnimeList);

                loading.classList.add('hidden');
                mainContent.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showError(err.message);
            }
        }

        function renderEpisodeList(episodes) {
            const container = document.getElementById('episode-grid');
            if (!episodes || episodes.length === 0) {
                container.innerHTML = '<p class="col-span-full text-gray-500">Belum ada episode.</p>';
                return;
            }

            let html = '';
            episodes.forEach(ep => {
                html += `
                <a href="watch.html?id=${ep.episodeId}" class="group bg-[#21262d] hover:bg-blue-700 border border-[#30363d] hover:border-blue-500 text-center py-3 px-2 rounded transition-all duration-200">
                    <span class="block text-xs text-gray-400 group-hover:text-blue-200 mb-1">Episode</span>
                    <span class="block text-lg font-bold text-white">${ep.title}</span>
                </a>`;
            });
            container.innerHTML = html;
        }

        function renderRecommendations(list) {
            const container = document.getElementById('recommendation-grid');
            if (!list || list.length === 0) {
                container.parentElement.classList.add('hidden');
                return;
            }

            let html = '';
            list.forEach(anime => {
                const id = anime.animeId;
                const poster = anime.poster || 'https://via.placeholder.com/150';

                html += `
                <a href="detail.html?id=${id}" class="relative aspect-[3/4] overflow-hidden bg-gray-800 group shadow-lg rounded-md border border-[#30363d] hover:border-blue-500 transition-colors">
                    <img src="${poster}" alt="${anime.title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                    <div class="absolute bottom-0 w-full bg-black/70 backdrop-blur-[2px] p-2 border-t border-white/5">
                        <h3 class="text-white text-[11px] font-medium leading-tight line-clamp-2 text-center card-font group-hover:text-blue-400 transition-colors">
                            ${anime.title}
                        </h3>
                    </div>
                </a>`;
            });
            container.innerHTML = html;
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error-msg').classList.remove('hidden');
            document.getElementById('error-text').innerText = msg;
        }
    </script>
</body>
</html>
